# Обновление статуса компании и связанная логика

## Описание функциональности

При изменении статуса компании на "Холд" или "Отказ" автоматически выполняется следующая логика:

### 1. Обновление статусов товаров
- Все товары, связанные с компанией, автоматически получают тот же статус ("Холд" или "Отказ")
- Обновление происходит в рамках транзакции базы данных для обеспечения целостности данных

### 2. Создание действия при статусе "Отказ"
- При установке статуса "Отказ" автоматически создается действие с текстом: "Уточнить наличие станков и дальнейший статус компании"
- Срок выполнения действия: текущая дата + 6 месяцев
- Действие создается как невыполненное (status = false)

### 3. Логирование
- Все изменения записываются в лог компании
- В логе указывается:
  - Смена статуса компании
  - Количество обновленных товаров (если есть)
  - Создание действия (если применимо)
  - Комментарий пользователя

## Техническая реализация

### Изменения в моделях

#### Company.php
Добавлена связь с товарами:
```php
public function products(): HasMany
{
    return $this->hasMany(Product::class);
}
```

### Изменения в контроллере

#### CompanyController.php - метод updateStatus()
- Добавлена транзакция базы данных (DB::beginTransaction/commit/rollback)
- Логика обновления статусов товаров
- Логика создания действия при статусе "Отказ"
- Расширенное логирование

### Тестирование

Создана команда для тестирования функциональности:
```bash
php artisan test:company-status-update [company_id]
```

Команда тестирует:
- Изменение статуса на "Холд"
- Изменение статуса на "Отказ"
- Обновление статусов товаров
- Создание действий
- Логирование

## Использование

### Через веб-интерфейс
1. Перейдите на страницу компании
2. Нажмите на текущий статус компании
3. Выберите новый статус ("Холд" или "Отказ")
4. Введите комментарий
5. Нажмите "Сохранить"

### Через API
```http
PATCH /company/{company_id}/status
Content-Type: application/json

{
    "status_id": 3, // ID статуса "Холд" или "Отказ"
    "comment": "Комментарий к смене статуса"
}
```

## Структура статусов

### Статусы компаний
- В работе (ID: 1)
- Вторая очередь (ID: 2)
- Холд (ID: 3)
- Отказ (ID: 4)

### Статусы товаров
- В работе (ID: 1)
- В продаже (ID: 2)
- Резерв (ID: 3)
- Холд (ID: 4)
- Продано (ID: 5)
- Вторая очередь (ID: 6)
- Отказ (ID: 7)

## Безопасность

- Проверка прав пользователя на обновление статуса компании
- Валидация входных данных
- Транзакции базы данных для обеспечения целостности
- Логирование всех изменений

## Обработка ошибок

- Все операции выполняются в транзакции
- При ошибке происходит откат всех изменений
- Возвращается подробное сообщение об ошибке
- Логирование ошибок в системный лог

## Мониторинг

Для мониторинга работы функциональности можно использовать:
- Логи компании (CompanyLog)
- Действия компании (CompanyActions)
- Статусы товаров (Product.status_id)
