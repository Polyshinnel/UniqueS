# Логирование изменений общего комментария после осмотра товара

## Описание

Добавлена функциональность для автоматического создания системных логов при изменении поля "Общий комментарий после осмотра" в товарах. Система отслеживает изменения и создает лог с информацией о том, что было изменено.

## Что было реализовано

### 1. Обновлен контроллер `ProductController`

#### Метод `update()`
- Добавлено сохранение старого значения комментария перед обновлением
- Добавлена проверка изменения поля `common_commentary_after`
- При изменении создается системный лог с форматированным сообщением

#### Метод `updateComment()`
- Добавлена аналогичная логика для AJAX-обновлений
- Поддерживает обновление комментария через отдельный метод

### 2. Формат лога

Система создает лог в следующем формате:
```
"Изменен Общий комментарий после осмотра, с \"старый текст\" на \"новый текст\""
```

Если комментарий был пустым или стал пустым, используется текст "пустой комментарий".

### 3. Тип лога

Используется тип лога "Системный" (LogType с name = 'Системный'), который создается автоматически при миграции.

### 4. Создатель лога

Лог создается от имени системы (`user_id = null`), что означает автоматическое создание без привязки к конкретному пользователю.

## Структура данных

### Таблица `product_logs`
- `id` - уникальный идентификатор
- `product_id` - ID товара
- `user_id` - NULL (от имени системы)
- `type_id` - ID типа лога "Системный"
- `log` - текст лога с информацией об изменении
- `created_at` - дата создания
- `updated_at` - дата обновления

### Таблица `log_types`
- `id` - уникальный идентификатор
- `name` - "Системный"
- `color` - цвет для отображения (например, "#6c757d")

## Команды для тестирования

### Тестирование функциональности
```bash
php artisan test:product-commentary-log {product_id}
```

Эта команда:
1. Проверяет существование товара
2. Показывает текущий комментарий
3. Проверяет наличие типа лога "Системный"
4. Отображает последние логи товара
5. Создает тестовый лог для демонстрации

### Примеры использования

#### Тестирование с товаром ID 1
```bash
php artisan test:product-commentary-log 1
```

#### Просмотр существующих логов товара
```bash
php artisan test:product-log 1
```

## Примеры логов

### Изменение с пустого на заполненный
```
Изменен Общий комментарий после осмотра, с "пустой комментарий" на "Станок в хорошем состоянии, требует небольшого ремонта"
```

### Изменение с заполненного на пустой
```
Изменен Общий комментарий после осмотра, с "Станок в хорошем состоянии" на "пустой комментарий"
```

### Изменение содержимого
```
Изменен Общий комментарий после осмотра, с "Станок требует ремонта" на "Станок полностью исправен и готов к работе"
```

## Отображение на странице

Логи отображаются в блоке "Лог событий" на странице просмотра товара (`ProductItemPage.blade.php`):

1. **Тип лога** - "Системный" с соответствующим цветом
2. **Дата и время** - в формате `dd.mm.yyyy hh:mm:ss`
3. **Текст лога** - подробное описание изменения
4. **Создатель** - "Система" (так как `user_id = NULL`)

## Технические детали

### Условия создания лога
Лог создается только при фактическом изменении значения поля `common_commentary_after`. Если значение не изменилось, лог не создается.

### Обработка пустых значений
- Если старое значение было пустым, в логе отображается "пустой комментарий"
- Если новое значение стало пустым, в логе отображается "пустой комментарий"

### Безопасность
- Логирование происходит в рамках транзакции обновления товара
- При ошибке создания лога основная операция обновления не прерывается
- Проверяется существование типа лога перед созданием записи

## Интеграция с существующей системой

Функциональность интегрирована с существующей системой логов товаров:
- Использует существующую модель `ProductLog`
- Использует существующий тип лога "Системный"
- Отображается в существующем интерфейсе просмотра логов
- Поддерживает все существующие команды для работы с логами 