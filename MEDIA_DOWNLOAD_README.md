# Функциональность скачивания медиафайлов товаров

## Описание

Добавлена возможность скачивания всех медиафайлов товара в виде ZIP архива. Функция доступна на странице просмотра товара.

## Возможности

- ✅ Скачивание всех медиафайлов товара в одном ZIP архиве
- ✅ Проверка прав доступа пользователя
- ✅ Анимация загрузки во время создания архива
- ✅ Автоматическое удаление архива после скачивания
- ✅ Обработка ошибок и уведомления пользователя
- ✅ Безопасные имена файлов в архиве

## Как использовать

### Для пользователей

1. Перейдите на страницу товара
2. В блоке с медиафайлами найдите кнопку "Скачать все медиа"
3. Нажмите на кнопку - начнется создание архива
4. Дождитесь завершения скачивания
5. Архив автоматически удалится с сервера после скачивания

### Для администраторов

#### Очистка временных файлов

Для очистки старых временных архивов используйте команду:

```bash
# Очистить архивы старше 24 часов (по умолчанию)
php artisan cleanup:temp-archives

# Очистить архивы старше 12 часов
php artisan cleanup:temp-archives --hours=12

# Очистить архивы старше 48 часов
php artisan cleanup:temp-archives --hours=48
```

#### Настройка автоматической очистки

Добавьте в cron задачу для автоматической очистки:

```bash
# Добавьте в crontab
0 2 * * * cd /path/to/your/project && php artisan cleanup:temp-archives
```

## Технические детали

### Файлы

- **Контроллер**: `app/Http/Controllers/Product/ProductController.php`
  - Метод: `downloadMedia()`
  - Метод: `sanitizeFileName()`

- **Маршрут**: `routes/web.php`
  - `GET /product/{product}/download-media`

- **Шаблон**: `resources/views/Product/ProductItemPage.blade.php`
  - Кнопка скачивания и JavaScript функция

- **Команда очистки**: `app/Console/Commands/CleanupTempArchives.php`

### Права доступа

Скачивание медиафайлов доступно для:
- Администраторов (все товары)
- Владельцев товара (свои товары)
- Региональных представителей (товары в их регионе)

### Безопасность

- Проверка прав доступа перед созданием архива
- Санитизация имен файлов для предотвращения проблем с файловой системой
- Ограничение длины имен файлов
- Автоматическое удаление архивов после скачивания

### Производительность

- Архивы создаются во временной директории `storage/app/temp`
- Используется встроенный PHP класс `ZipArchive`
- Файлы удаляются автоматически после скачивания
- Команда очистки удаляет старые архивы

## Обработка ошибок

Система обрабатывает следующие ошибки:
- Отсутствие прав доступа (403)
- Отсутствие медиафайлов у товара (404)
- Ошибки создания архива (500)
- Сетевые ошибки

Все ошибки отображаются пользователю в виде уведомлений.

## Мониторинг

Для мониторинга использования функции можно:
1. Проверить размер директории `storage/app/temp`
2. Запустить команду очистки с подробным выводом
3. Проверить логи Laravel на наличие ошибок

## Требования

- PHP 8.1+ с поддержкой ZipArchive
- Laravel 10+
- Достаточно места на диске для временных архивов
