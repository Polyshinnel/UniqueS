# Команда проверки объявлений в резерве

## Описание

Команда `advertisements:check-reserved` автоматически проверяет объявления, находящиеся в статусе "Резерв" более 7 дней, и переводит их в статус "Ревизия" вместе со связанными товарами.

## Что делает команда

1. **Находит объявления** в статусе "Резерв", которые не обновлялись 7 дней и более
2. **Переводит статус объявления** с "Резерв" на "Ревизия"
3. **Переводит статус товара** с текущего на "Ревизия"
4. **Создает логи** для объявления и товара с описанием причины изменения
5. **Создает задачи** для менеджера товара и создателя объявления о необходимости актуализации статуса

## Использование

### Ручной запуск

Вы можете запустить команду вручную через терминал:

```bash
php artisan advertisements:check-reserved
```

### Автоматический запуск

Команда настроена на автоматический запуск **каждый день** через планировщик задач Laravel.

Для работы планировщика убедитесь, что в cron добавлена запись:

```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

## Пример вывода команды

```
Начало проверки объявлений в статусе "Резерв"...

Найдено объявлений для обработки: 3

Обработка объявления ID: 15 - Токарный станок
  ✓ Создана задача для менеджера ID: 5
  ✓ Создана задача для создателя объявления ID: 5
  ✓ Статусы успешно обновлены: Резерв → Ревизия

Обработка объявления ID: 23 - Фрезерный станок
  ✓ Создана задача для менеджера ID: 3
  ✓ Создана задача для создателя объявления ID: 3
  ✓ Статусы успешно обновлены: Резерв → Ревизия

=== Результаты обработки ===
Всего найдено: 3
Успешно обработано: 3

Проверка завершена.
```

## Созданные записи

### Логи объявления
```
Прошло {X} дней с момента резервирования данного объявления. 
Статус автоматически изменен на 'Ревизия'. 
Требуется актуализировать статус.
```

### Логи товара
```
Прошло {X} дней с момента резервирования данного товара. 
Статус автоматически изменен на 'Ревизия'. 
Требуется актуализировать статус.
```

### Задачи (Actions)
```
Прошло {X} дней с момента постановки товара/объявления в резерв. 
Требуется актуализация статуса.
```
**Срок выполнения**: 1 день с момента создания задачи

## Требования

- Статус "Резерв" для объявлений (ID должен соответствовать в таблице `advertisement_statuses`)
- Статус "Ревизия" для объявлений и товаров (ID должен соответствовать в таблицах)
- Тип лога "Системный" в таблице `log_types`

## Логика работы

Команда проверяет поле `updated_at` объявления. Если с момента последнего обновления прошло **7 или более дней**, объявление считается просроченным и автоматически переводится в ревизию.

## Расположение файлов

- **Команда**: `app/Console/Commands/CheckReservedAdvertisements.php`
- **Планировщик**: `app/Console/Kernel.php`

## Отладка

Для просмотра всех зарегистрированных команд:
```bash
php artisan list
```

Для получения справки по команде:
```bash
php artisan help advertisements:check-reserved
```

## Примечания

- Команда обрабатывает только объявления, связанные с товарами
- Если у товара нет владельца (`owner_id`), задача для него не создается, но статус все равно обновляется
- Все действия логируются от имени системы (user_id = null)
- При возникновении ошибок команда продолжает работу с остальными объявлениями

