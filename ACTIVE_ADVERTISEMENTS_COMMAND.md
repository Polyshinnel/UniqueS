# Команда проверки объявлений в продаже

## Описание

Команда `advertisements:check-active` автоматически проверяет объявления, находящиеся в статусе "В продаже" более 30 дней, и переводит их в статус "Ревизия" вместе со связанными товарами.

## Что делает команда

1. **Находит объявления** в статусе "В продаже", которые не обновлялись 30 дней и более
2. **Переводит статус объявления** с "В продаже" на "Ревизия"
3. **Переводит статус товара** с текущего на "Ревизия"
4. **Создает логи** для объявления и товара с описанием причины изменения
5. **Создает задачи** для менеджера товара и создателя объявления о необходимости актуализации информации

## Использование

### Ручной запуск

Вы можете запустить команду вручную через терминал:

```bash
php artisan advertisements:check-active
```

### Автоматический запуск

Команда настроена на автоматический запуск **каждый день** через планировщик задач Laravel.

Для работы планировщика убедитесь, что в cron добавлена запись:

```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

## Пример вывода команды

```
Начало проверки объявлений в статусе "В продаже"...

Найдено объявлений для обработки: 2

Обработка объявления ID: 42 - Токарный станок 1К62
  ✓ Создана задача для менеджера ID: 5
  ✓ Создана задача для создателя объявления ID: 5
  ✓ Статусы успешно обновлены: В продаже → Ревизия
  ℹ Товар находился в продаже 35 дней

Обработка объявления ID: 58 - Фрезерный станок 6Р13
  ✓ Создана задача для менеджера ID: 3
  ✓ Создана задача для создателя объявления ID: 3
  ✓ Статусы успешно обновлены: В продаже → Ревизия
  ℹ Товар находился в продаже 32 дня

=== Результаты обработки ===
Всего найдено: 2
Успешно обработано: 2

Проверка завершена.
```

## Созданные записи

### Логи объявления
```
Прошло {X} дней с момента публикации объявления в статусе 'В продаже'. 
Статус автоматически изменен на 'Ревизия'. 
Требуется актуализировать статус и информацию о товаре.
```

### Логи товара
```
Прошло {X} дней с момента публикации связанного объявления в статусе 'В продаже'. 
Статус товара автоматически изменен на 'Ревизия'. 
Требуется актуализировать статус и информацию о товаре.
```

### Задачи (Actions)

**Для товара:**
```
Прошло {X} дней с момента публикации товара. 
Требуется актуализация статуса, проверка наличия и актуальности информации.
```

**Для объявления:**
```
Прошло {X} дней с момента публикации объявления. 
Требуется актуализация информации, проверка актуальности цены и описания.
```

**Срок выполнения**: 3 дня с момента создания задачи

## Отличия от команды check-reserved

| Параметр | check-reserved | check-active |
|----------|----------------|--------------|
| Статус объявления | Резерв | В продаже |
| Период проверки | 7 дней | 30 дней |
| Срок выполнения задачи | 1 день | 3 дня |
| Акцент в задачах | Актуализация статуса | Проверка актуальности информации и цены |

## Требования

- Статус "В продаже" для объявлений (ID должен соответствовать в таблице `advertisement_statuses`)
- Статус "Ревизия" для объявлений и товаров (ID должен соответствовать в таблицах)
- Тип лога "Системный" в таблице `log_types`

## Логика работы

Команда проверяет поле `updated_at` объявления. Если с момента последнего обновления прошло **30 или более дней**, объявление считается требующим актуализации и автоматически переводится в ревизию.

## Расположение файлов

- **Команда**: `app/Console/Commands/CheckActiveAdvertisements.php`
- **Планировщик**: `app/Console/Kernel.php`

## Отладка

Для просмотра всех зарегистрированных команд:
```bash
php artisan list
```

Для получения справки по команде:
```bash
php artisan help advertisements:check-active
```

## Примечания

- Команда обрабатывает только объявления, связанные с товарами
- Если у товара нет владельца (`owner_id`), задача для него не создается, но статус все равно обновляется
- Все действия логируются от имени системы (user_id = null)
- При возникновении ошибок команда продолжает работу с остальными объявлениями
- Задачи создаются с более длинным сроком (3 дня вместо 1), т.к. требуется более тщательная проверка информации

## Почему 30 дней?

30-дневный период выбран для того, чтобы:
- Дать достаточно времени для продажи товара
- Обеспечить актуальность информации о товаре
- Проверить, что товар все еще доступен для продажи
- Актуализировать цену и описание при необходимости

## Взаимодействие с другими командами

Данная команда работает независимо от `advertisements:check-reserved`, но обе команды:
- Переводят объявления в статус "Ревизия"
- Создают аналогичные логи и задачи
- Выполняются ежедневно через планировщик

Рекомендуется настроить обе команды для полного контроля жизненного цикла объявлений.

