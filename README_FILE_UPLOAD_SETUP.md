# Настройка загрузки больших файлов

## Проблема
При загрузке товаров с большими файлами (общий размер более 500MB) возникает ошибка 413 (Content Too Large).

## Решение

### 1. Настройки PHP
Файл `php.ini` уже настроен правильно:
```ini
upload_max_filesize = 1000M
post_max_size = 1000M
max_execution_time = 300
max_input_time = 300
memory_limit = 512M
max_file_uploads = 50
```

### 2. Настройки Apache (.htaccess)
Файл `public/.htaccess` уже содержит необходимые настройки для Apache.

### 3. Настройки Nginx
Если используется Nginx, добавьте в конфигурацию сервера:
```nginx
client_max_body_size 1000M;
client_body_timeout 300s;
client_header_timeout 300s;
```

### 4. Laravel Middleware
Создан middleware `LargeFileUploadMiddleware` для обработки больших файлов:
- Увеличивает лимиты PHP во время выполнения
- Проверяет общий размер загружаемых файлов
- Возвращает понятные ошибки при превышении лимитов

### 5. Обновления в коде

#### Контроллер (ProductController.php)
- Увеличен лимит размера файла с 100MB до 1000MB
- Добавлена проверка общего размера файлов
- Улучшена обработка ошибок

#### Представление (ProductCreatePage.blade.php)
- Обновлены лимиты в JavaScript
- Добавлена проверка общего размера файлов на клиентской стороне
- Улучшена обработка ошибок загрузки

#### Маршруты (web.php)
- Добавлен middleware `large.file.upload` к маршруту создания товара

### 6. Проверка настроек

#### Для Apache:
1. Убедитесь, что модуль `mod_php` или `mod_fastcgi` включен
2. Проверьте, что файл `.htaccess` загружается

#### Для Nginx:
1. Добавьте настройки из файла `nginx.conf`
2. Перезапустите Nginx: `sudo systemctl restart nginx`

#### Для PHP:
1. Проверьте текущие настройки: `php -i | grep -E "(upload_max_filesize|post_max_size|memory_limit)"`
2. Убедитесь, что используется правильный `php.ini`

### 7. Тестирование
1. Попробуйте загрузить файлы общим размером до 1000MB
2. Проверьте, что ошибки обрабатываются корректно
3. Убедитесь, что прогресс-бар работает правильно

### 8. Дополнительные рекомендации

#### Для очень больших файлов (>500MB):
- Рассмотрите возможность загрузки файлов по частям (chunked upload)
- Используйте очереди для обработки файлов
- Настройте временные директории с достаточным местом

#### Мониторинг:
- Следите за использованием памяти сервера
- Настройте логирование ошибок загрузки
- Мониторьте время выполнения запросов

### 9. Устранение неполадок

#### Если ошибка 413 все еще возникает:
1. Проверьте настройки веб-сервера (Apache/Nginx)
2. Убедитесь, что middleware применяется
3. Проверьте логи ошибок сервера

#### Если файлы не загружаются:
1. Проверьте права доступа к папке `storage/app/public`
2. Убедитесь, что символическая ссылка создана: `php artisan storage:link`
3. Проверьте свободное место на диске

#### Если загрузка медленная:
1. Увеличьте `max_execution_time` и `max_input_time`
2. Настройте буферы веб-сервера
3. Рассмотрите использование CDN для статических файлов 