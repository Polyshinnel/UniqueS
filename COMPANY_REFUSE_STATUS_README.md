# Перевод компании в статус "Отказ" - Документация

## Описание функциональности

При переводе компании в статус "Отказ" автоматически выполняется комплексная логика, которая затрагивает компанию, все связанные товары и объявления.

## Алгоритм выполнения

### 1. Создание задачи для компании
- **Действие**: Создается задача для компании
- **Текст задачи**: "Актуализировать данные, уточнить по оборудованию и ценам"
- **Срок выполнения**: Текущая дата + 6 месяцев
- **Статус**: Не выполнено (false)

### 2. Обработка товаров компании
- **Условие**: Все товары компании, кроме тех, которые находятся в статусах "Продано", "Отказ"
- **Действие**: Перевод товаров в статус "Отказ"
- **Логирование**: Для каждого переведенного товара создается системный лог
- **Текст лога**: "В связи с переводом компании [Имя компании] в статус Отказ, товар переводится в статус Отказ."
- **Задача**: Для каждого товара создается задача
- **Текст задачи**: "Актуализировать данные по товару, информации о проверке, погрузке, демонтаже, комплектации и стоимости."
- **Срок выполнения**: Текущая дата + 6 месяцев

### 3. Обработка объявлений
- **Условие**: Все объявления связанные с затронутыми товарами, кроме тех, которые находятся в статусах "Продано", "Архив"
- **Действие**: Перевод объявлений в статус "Архив"
- **Логирование**: Для каждого переведенного объявления создается системный лог
- **Текст лога**: "В связи с переводом компании [Имя компании] в статус Отказ, объявление переводится в статус Архив."
- **Задача**: Для каждого объявления создается задача
- **Текст задачи**: "Актуализировать данные по объявлению, скорректировать текст объявления, условия продажи и стоимость."
- **Срок выполнения**: Текущая дата + 6 месяцев

## Техническая реализация

### Изменения в контроллере

#### CompanyController.php
- Добавлен метод `handleCompanyRefuseStatus()` для обработки перевода в статус "Отказ"
- Обновлен метод `updateStatus()` для вызова специальной обработки при статусе "Отказ"

### Модели данных

#### Используемые модели
- `Company` - компания
- `CompanyActions` - действия компании
- `CompanyLog` - логи компании
- `Product` - товары
- `ProductStatus` - статусы товаров
- `ProductLog` - логи товаров
- `ProductAction` - действия товаров
- `Advertisement` - объявления
- `AdvertisementStatus` - статусы объявлений
- `AdvLog` - логи объявлений
- `AdvAction` - действия объявлений
- `LogType` - типы логов

### Транзакции базы данных
Все операции выполняются в рамках транзакции для обеспечения целостности данных. В случае ошибки все изменения откатываются.

## Тестирование

### Команда для тестирования
```bash
php artisan test:company-refuse-status {company_id}
```

### Что тестирует команда
1. Перевод компании в статус "Отказ"
2. Создание задачи для компании
3. Обновление статусов товаров
4. Создание логов и задач для товаров
5. Обновление статусов объявлений
6. Создание логов и задач для объявлений

### Пример использования
```bash
php artisan test:company-refuse-status 1
```

## Использование через веб-интерфейс

### Процесс выполнения
1. Перейдите на страницу компании
2. Нажмите на текущий статус компании
3. Выберите статус "Отказ"
4. Введите комментарий к смене статуса
5. Нажмите "Сохранить"

### Что происходит автоматически
- Статус компании изменяется на "Отказ"
- Создается задача для компании
- Все подходящие товары переводятся в статус "Отказ"
- Для каждого товара создается лог и задача
- Все подходящие объявления переводятся в статус "Архив"
- Для каждого объявления создается лог и задача

## Безопасность

### Проверки прав доступа
- Проверка авторизации пользователя
- Проверка роли пользователя
- Проверка прав на работу с компанией

### Валидация данных
- Проверка существования статуса
- Валидация комментария
- Проверка существования связанных записей

## Логирование

### Типы логов
- **Системные логи**: Создаются от имени системы (user_id = null)
- **Пользовательские логи**: Создаются от имени пользователя

### Структура логов
- Логи компании: `company_logs`
- Логи товаров: `product_logs`
- Логи объявлений: `adv_logs`

## Структура статусов

### Статусы компаний
- В работе
- Вторая очередь
- Холд
- Отказ

### Статусы товаров
- В работе
- В продаже
- Резерв
- Холд
- Продано
- Вторая очередь
- Отказ

### Статусы объявлений
- Ревизия
- Активное
- Холд
- Продано
- Архив

## Обработка ошибок

### Возможные ошибки
1. Статус "Отказ" не найден в базе данных
2. Статус "Архив" не найден в базе данных
3. Ошибка при создании задач
4. Ошибка при создании логов
5. Ошибка при обновлении статусов

### Обработка ошибок
- Все операции выполняются в транзакции
- При ошибке все изменения откатываются
- Возвращается сообщение об ошибке пользователю
- Ошибки логируются в системный лог

## Производительность

### Оптимизации
- Использование массовых обновлений для статусов
- Минимизация запросов к базе данных
- Эффективная загрузка связанных данных

### Рекомендации
- Для компаний с большим количеством товаров и объявлений рекомендуется выполнять операцию в нерабочее время
- Регулярно очищать старые логи для оптимизации производительности

## Отличия от статуса "Холд"

### Сроки выполнения
- **Холд**: 3 месяца
- **Отказ**: 6 месяцев

### Статусы товаров
- **Холд**: Товары переводятся в статус "Холд"
- **Отказ**: Товары переводятся в статус "Отказ"

### Статусы объявлений
- **Холд**: Объявления переводятся в статус "Холд"
- **Отказ**: Объявления переводятся в статус "Архив"

### Исключения для товаров
- **Холд**: Исключены статусы "Продано", "Холд", "Отказ"
- **Отказ**: Исключены статусы "Продано", "Отказ"

### Исключения для объявлений
- **Холд**: Исключены статусы "Продано", "Архив", "Холд"
- **Отказ**: Исключены статусы "Продано", "Архив" 