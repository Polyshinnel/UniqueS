# Исправление ошибки 413 (Content Too Large) для загрузки больших файлов

## Проблема
При загрузке товаров получается ошибка: `Failed to load resource: the server responded with a status of 413 (Content Too Large)`. Общий размер всех загружаемых файлов за один раз может превышать 500 мегабайт.

## Внесенные изменения

### 1. Обновлена конфигурация Nginx (`nginx.conf`)
- Увеличен `client_max_body_size` с 1000M до 2048M (2GB)
- Увеличены таймауты с 300s до 600s
- Увеличены размеры буферов
- Добавлены пути для временных файлов

### 2. Обновлена конфигурация PHP (`php.ini`)
- Увеличен `upload_max_filesize` с 1000M до 2048M (2GB)
- Увеличен `post_max_size` с 1000M до 2048M (2GB)
- Увеличен `max_execution_time` с 300 до 600 секунд
- Увеличен `memory_limit` с 512M до 1024M
- Увеличен `max_file_uploads` с 50 до 100

### 3. Обновлен middleware `LargeFileUploadMiddleware`
- Увеличены лимиты до 2GB
- Добавлена поддержка различных полей файлов (`media_files`, `files`, `images`, `photos`, `documents`)
- Улучшена обработка как массивов файлов, так и одиночных файлов

### 4. Добавлен middleware ко всем маршрутам загрузки файлов
- `POST /product` (создание товара) - уже был
- `PUT /product/{product}` (обновление товара) - добавлен
- `POST /advertisements` (создание объявления) - добавлен
- `PUT /advertisements/{advertisement}` (обновление объявления) - добавлен

## Необходимые действия для применения изменений

### 1. Перезапуск Nginx
```bash
# Для OpenServer
# Перезапустите OpenServer через панель управления

# Или для обычного nginx
sudo systemctl restart nginx
```

### 2. Перезапуск PHP-FPM
```bash
# Для OpenServer
# Перезапустите OpenServer через панель управления

# Или для обычного PHP-FPM
sudo systemctl restart php8.1-fpm
```

### 3. Очистка кэша Laravel
```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
```

### 4. Проверка конфигурации
Убедитесь, что изменения применились:
```bash
# Проверка nginx
nginx -t

# Проверка PHP
php -i | grep -E "(upload_max_filesize|post_max_size|max_execution_time|memory_limit)"
```

## Тестирование
После применения изменений попробуйте загрузить файлы общим размером до 2GB. Система должна корректно обрабатывать такие запросы.

## Дополнительные рекомендации

### 1. Мониторинг производительности
При загрузке больших файлов следите за:
- Использованием памяти сервера
- Временем выполнения запросов
- Размером логов

### 2. Альтернативные решения для очень больших файлов
Если файлы превышают 2GB, рассмотрите:
- Загрузку файлов по частям (chunked upload)
- Использование прямых ссылок на облачное хранилище
- Асинхронную обработку файлов через очереди

### 3. Безопасность
- Убедитесь, что загружаемые файлы проходят валидацию
- Ограничьте типы разрешенных файлов
- Настройте антивирусную проверку

## Логирование
Для отладки проблем с загрузкой файлов проверьте:
- Логи Nginx: `/var/log/nginx/error.log`
- Логи PHP: `/var/log/php/error.log`
- Логи Laravel: `storage/logs/laravel.log` 