# Система управления товарами и объявлениями

## Обзор системы

Веб-приложение на Laravel для управления товарами, компаниями, объявлениями с комплексной системой логирования, статусов и действий.

## Основные модули

### 1. Управление товарами (Products)
- Создание, редактирование, просмотр товаров
- Загрузка медиафайлов (до 2GB)
- Система статусов: В работе, В продаже, Резерв, Холд, Продано, Вторая очередь, Отказ
- Логирование изменений и действий
- Автоматическое создание задач при смене статусов

### 2. Управление объявлениями (Advertisements)
- Создание и редактирование объявлений
- Связь с товарами
- Система статусов: Ревизия, Активное, Холд, Продано, Архив
- Проверка статуса товара при изменении статуса объявления
- Логирование изменений блоков объявлений

### 3. Управление компаниями (Companies)
- Создание и управление компаниями
- Система статусов: В работе, Вторая очередь, Холд, Отказ
- Автоматическое обновление статусов товаров и объявлений
- Ограничение доступа к регионам по ролям

### 4. Система логирования
- Логи для товаров, объявлений и компаний
- Типизированные логи с цветовой индикацией
- Системные и пользовательские логи
- Автоматическое создание логов при изменениях

### 5. Система действий (Tasks)
- Создание задач для товаров, объявлений и компаний
- Отметка выполнения с комментариями
- Автоматическое создание задач при смене статусов
- Сроки выполнения и уведомления

## Структура базы данных

### Основные таблицы
- `products` - товары
- `advertisements` - объявления
- `companies` - компании
- `users` - пользователи
- `regions` - регионы
- `warehouses` - склады
- `product_categories` - категории товаров

### Таблицы статусов
- `product_statuses` - статусы товаров
- `advertisement_statuses` - статусы объявлений
- `company_statuses` - статусы компаний

### Таблицы логов
- `product_logs` - логи товаров
- `adv_logs` - логи объявлений
- `company_logs` - логи компаний
- `log_types` - типы логов

### Таблицы действий
- `product_actions` - действия товаров
- `adv_actions` - действия объявлений
- `company_actions` - действия компаний

### Связующие таблицы
- `users_to_regions` - связь пользователей с регионами
- `warehouses_to_regions` - связь складов с регионами
- `company_to_warehouses` - связь компаний со складами

## Ключевые функции

### Автоматическая обработка статусов

#### Перевод компании в статус "Холд"
1. Создание задачи для компании (срок +3 месяца)
2. Перевод товаров в статус "Холд" (кроме исключенных)
3. Перевод объявлений в статус "Холд" (кроме исключенных)
4. Создание системных логов и задач для всех изменений

#### Перевод компании в статус "Отказ"
1. Создание задачи для компании (срок +6 месяцев)
2. Перевод товаров в статус "Отказ" (кроме исключенных)
3. Перевод объявлений в статус "Архив" (кроме исключенных)
4. Создание системных логов и задач для всех изменений

#### Перевод товара в статус "Холд"/"Отказ"
1. Создание задачи для товара
2. Перевод связанных объявлений в соответствующие статусы
3. Создание системных логов и задач

### Проверка статусов объявлений
- Блокировка перевода объявления в статусы "Ревизия", "Активное", "Резерв" если товар в статусе "Холд" или "Отказ"
- Показ предупреждения пользователю с инструкциями

### Система логирования
- Автоматическое создание логов при изменениях
- Логирование изменений блоков объявлений
- Логирование изменений комментариев товаров
- Системные логи от имени системы (user_id = null)

## Технические особенности

### Загрузка файлов
- Поддержка файлов до 2GB
- Структурированное хранение по артикулам организаций и товаров
- Транслитерация имен папок
- Middleware для обработки больших файлов

### Ограничения доступа
- Роли пользователей (администратор, обычный пользователь)
- Ограничение доступа к регионам
- Проверка прав на уровне контроллеров

### Категории товаров
- Древовидная структура категорий
- Ограничение выбора только категориями без подкатегорий
- Визуальные индикаторы доступности

## API Endpoints

### Товары
- `GET /products` - список товаров
- `GET /product/{id}` - просмотр товара
- `POST /product` - создание товара
- `PUT /product/{id}` - обновление товара
- `PATCH /product/{id}/status` - изменение статуса
- `GET /product/{id}/logs` - логи товара
- `GET /product/{id}/actions` - действия товара

### Объявления
- `GET /advertisements` - список объявлений
- `GET /advertisement/{id}` - просмотр объявления
- `POST /advertisements` - создание объявления
- `PUT /advertisements/{id}` - обновление объявления
- `PATCH /advertisements/{id}/status` - изменение статуса
- `PATCH /advertisements/{id}/comment` - обновление комментария

### Компании
- `GET /companies` - список компаний
- `GET /company/{id}` - просмотр компании
- `POST /company` - создание компании
- `PATCH /company/{id}/status` - изменение статуса

## Команды для тестирования

### Тестирование статусов
```bash
# Тестирование перевода компании в статус "Холд"
php artisan test:company-hold-status {company_id}

# Тестирование перевода компании в статус "Отказ"
php artisan test:company-refuse-status {company_id}

# Тестирование перевода товара в статус
php artisan test:product-status {product_id} {status}
```

### Создание тестовых данных
```bash
# Создание тестовых логов
php artisan test:create-adv-log
php artisan test:create-adv-action
php artisan test:create-product-log
php artisan test:create-product-action

# Создание тестовых логов для компаний
php artisan create:test-log {company_id} --type=1 --user=1 --message="Тестовый лог"
```

### Проверка статусов
```bash
# Проверка статусов холд
php artisan check:hold-statuses
```

## Настройка и развертывание

### Требования
- PHP 8.1+
- Laravel 10+
- MySQL/PostgreSQL
- Nginx/Apache

### Конфигурация для больших файлов
- `upload_max_filesize = 2048M`
- `post_max_size = 2048M`
- `max_execution_time = 600`
- `memory_limit = 1024M`

### Миграции и сидеры
```bash
php artisan migrate
php artisan db:seed
php artisan storage:link
```

## Безопасность

- Проверка прав доступа на уровне контроллеров
- Валидация входных данных
- Транзакции базы данных для критических операций
- Логирование всех изменений
- Ограничение доступа к регионам по ролям

## Мониторинг и логирование

- Системные логи для автоматических операций
- Пользовательские логи для ручных изменений
- Типизированные логи с цветовой индикацией
- Автоматическое создание задач при изменениях статусов

## Поддержка и развитие

Система разработана с учетом масштабируемости и расширяемости. Все основные операции выполняются в транзакциях для обеспечения целостности данных. 