# Ограничение доступа к регионам при создании компании

## Описание

Реализована система ограничения доступа к регионам при создании компании. Пользователи могут видеть и выбирать только те регионы, которые им назначены администратором.

## Функциональность

### 1. Ограничение доступа по ролям

- **Администраторы (role_id = 1)**: Видят все активные регионы
- **Обычные пользователи**: Видят только назначенные им регионы

### 2. Проверка на уровне контроллера

В контроллере `CompanyController` реализованы следующие изменения:

#### Метод `create()`
- Получает только доступные пользователю регионы
- Передает их в представление для отображения

#### Метод `store()`
- Проверяет, что выбранный регион доступен пользователю
- Возвращает ошибку, если регион недоступен

#### Метод `getUserRegions()`
- Приватный метод для получения доступных регионов
- Учитывает роль пользователя и его назначения

### 3. Обновление представления

В представлении `CompanyCreatePage.blade.php`:
- Показывается предупреждение, если у пользователя нет доступных регионов
- Кнопка "Следующий шаг" блокируется при отсутствии регионов
- Селект с регионами отключается при отсутствии доступа

## Структура базы данных

### Таблица `users_to_regions`
Связующая таблица между пользователями и регионами:
- `user_id` - ID пользователя
- `region_id` - ID региона
- `timestamps` - временные метки

### Связи в моделях

#### User.php
```php
public function regions()
{
    return $this->belongsToMany(Regions::class, 'users_to_regions', 'user_id', 'region_id')
        ->withTimestamps();
}
```

## Использование

### Назначение регионов пользователю

```php
// Назначить регион пользователю
$user->regions()->attach($regionId);

// Назначить несколько регионов
$user->regions()->attach([$regionId1, $regionId2]);

// Удалить назначение
$user->regions()->detach($regionId);
```

### Проверка доступности региона

```php
// В контроллере
$userRegions = $this->getUserRegions()->pluck('id')->toArray();
if (!in_array($requestedRegionId, $userRegions)) {
    // Регион недоступен
}
```

## Тестирование

Создан тест `CompanyCreateRegionsTest.php` с проверками:

1. **test_user_can_only_see_their_assigned_regions()** - проверяет, что пользователь видит только свои регионы
2. **test_admin_can_see_all_regions()** - проверяет, что администратор видит все регионы
3. **test_user_cannot_create_company_with_inaccessible_region()** - проверяет блокировку создания компании с недоступным регионом

### Запуск тестов

```bash
php artisan test tests/Feature/CompanyCreateRegionsTest.php
```

## Безопасность

- Проверка доступа происходит как на уровне представления, так и на уровне контроллера
- Двойная проверка в методе `store()` предотвращает обход ограничений
- Использование прямых SQL-запросов для получения доступных регионов исключает проблемы с кэшированием связей

## Расширение функциональности

Для добавления новых ролей с особыми правами доступа к регионам:

1. Обновите метод `getUserRegions()` в контроллере
2. Добавьте соответствующие проверки
3. Обновите тесты для новых сценариев

## Примеры сообщений об ошибках

- "Выбранный регион недоступен для вашего пользователя" - при попытке создать компанию с недоступным регионом
- "У вас нет доступных регионов. Обратитесь к администратору для настройки доступа к регионам." - при отсутствии назначенных регионов 