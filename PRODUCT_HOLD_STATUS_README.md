# Логика перевода товара в статус "Холд" и "Отказ"

## Описание функциональности

При переводе товара в статус "Холд" или "Отказ" автоматически выполняются следующие действия:

### Статус "Холд"

### 1. Создание задачи для товара
- **Срок выполнения**: текущая дата + 3 месяца
- **Описание задачи**: "Актуализировать данные по товару, информации о проверке, погрузке, демонтаже, комплектации и стоимости."
- **Назначена на**: владельца товара (owner_id)

### 2. Обработка связанных объявлений
Система находит все объявления, связанные с товаром, которые НЕ находятся в статусах:
- "Продано"
- "Архив" 
- "Холд"

### 3. Перевод объявлений в статус "Холд"
Для каждого найденного объявления:
- Обновляется статус на "Холд"
- Создается системный лог с текстом: "В связи с переводом товара в статус Холд, объявление переводится в статус Холд."
- Создается задача со сроком выполнения: текущая дата + 3 месяца
- Описание задачи: "Актуализировать данные по объявлению, скорректировать текст объявления, условия продажи и стоимость."
- Назначена на: создателя объявления (created_by)

### Статус "Отказ"

### 1. Создание задачи для товара
- **Срок выполнения**: текущая дата + 6 месяцев
- **Описание задачи**: "Актуализировать данные по товару, информации о проверке, погрузке, демонтаже, комплектации и стоимости."
- **Назначена на**: владельца товара (owner_id)

### 2. Обработка связанных объявлений
Система находит все объявления, связанные с товаром, которые НЕ находятся в статусах:
- "Продано"
- "Архив"

### 3. Перевод объявлений в статус "Архив"
Для каждого найденного объявления:
- Обновляется статус на "Архив"
- Создается системный лог с текстом: "В связи с переводом товара в статус Отказ, объявление переводится в статус Архив."
- Создается задача со сроком выполнения: текущая дата + 6 месяцев
- Описание задачи: "Актуализировать данные по объявлению, скорректировать текст объявления, условия продажи и стоимость."
- Назначена на: создателя объявления (created_by)

## Реализация

### Основные методы
```php
private function handleProductHoldStatus(Product $product, $user)
private function handleProductRefuseStatus(Product $product, $user)
```

### Место вызова
Методы вызываются в `ProductController::updateStatus()` при переводе товара в соответствующий статус:

```php
// Специальная обработка для статуса "Холд"
if ($newStatus->name === 'Холд') {
    $this->handleProductHoldStatus($product, auth()->user());
}

// Специальная обработка для статуса "Отказ"
if ($newStatus->name === 'Отказ') {
    $this->handleProductRefuseStatus($product, auth()->user());
}
```

### Задействованные модели
- `Product` - товар
- `ProductAction` - задачи товара
- `ProductLog` - логи товара
- `Advertisement` - объявления
- `AdvertisementStatus` - статусы объявлений
- `AdvAction` - задачи объявлений
- `AdvLog` - логи объявлений
- `LogType` - типы логов

## Тестирование

Для тестирования функциональности создана команда:

```bash
# Для статуса "Холд"
php artisan test:product-status {product_id} Холд

# Для статуса "Отказ"
php artisan test:product-status {product_id} Отказ
```

Команда:
1. Показывает информацию о товаре и связанных объявлениях
2. Запрашивает подтверждение
3. Выполняет перевод в статус "Холд"
4. Отображает результаты операции

## Пример использования

### Статус "Холд"
1. Откройте страницу товара
2. Измените статус на "Холд"
3. Введите комментарий
4. Сохраните изменения

После этого автоматически:
- Создается задача для товара на 3 месяца вперед
- Все активные объявления переводятся в статус "Холд"
- Создаются системные логи для каждого объявления
- Создаются задачи для каждого объявления на 3 месяца вперед

### Статус "Отказ"
1. Откройте страницу товара
2. Измените статус на "Отказ"
3. Введите комментарий
4. Сохраните изменения

После этого автоматически:
- Создается задача для товара на 6 месяцев вперед
- Все активные объявления переводятся в статус "Архив"
- Создаются системные логи для каждого объявления
- Создаются задачи для каждого объявления на 6 месяцев вперед

## Логирование

Все действия логируются:
- Изменение статуса товара (комментарий пользователя)
- Системные логи для объявлений (автоматически)
- Создание задач (отображается в списке задач)

## Безопасность

- Все операции выполняются в транзакции
- Проверяются права доступа пользователя
- Валидируются входные данные
- Обрабатываются исключения 